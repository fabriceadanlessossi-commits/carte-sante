<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Carte Pharmacies & Établissements de santé</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<style>
  html, body, #app { height: 100%; margin: 0; }
  #map { height: calc(100% - 60px); }
  .topbar { position: sticky; top: 0; z-index: 1000; display: grid; grid-template-columns: auto 1fr auto auto; gap: 10px; align-items: center; padding: 10px; background: linear-gradient(90deg,#0b1220,#0f172a); color: #fff; box-shadow: 0 4px 18px rgba(0,0,0,.25); }
  .topbar input[type="search"] { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #334155; background: #0b1220; color: #e2e8f0; }
  .topbar .badge { background: #1e293b; padding: 6px 10px; border-radius: 999px; font-size: 12px; }
  .filter { display: flex; align-items: center; gap: 8px; }
  .filter label { font-size: 12px; opacity: .9; }
  .filter input[type="range"] { accent-color: #22c55e; width: 160px; }
  .legend { position: fixed; z-index: 1000; bottom: 14px; left: 14px; background: rgba(255,255,255,0.95); border-radius: 8px; padding: 10px; box-shadow: 0 6px 24px rgba(0,0,0,.15); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .legend h4 { margin: 0 0 6px; font-size: 14px; color: #0f172a; }
  .legend .row { display: flex; align-items: center; gap: 8px; margin: 4px 0; font-size: 13px; color: #0f172a; }
  .legend .swatch { width: 14px; height: 14px; border-radius: 50%; display: inline-block; border: 2px solid #0f172a11; }
  .legend .swatch.pharma { background: #16a34a; }
  .legend .swatch.ehpad { background: #2563eb; }
  .leaflet-control-layers { font-size: 13px; }
  .btn { background:#0ea5e9; color:#fff; border:0; padding:8px 10px; border-radius:6px; cursor:pointer; font-weight:600; }
  .btn[disabled] { opacity: .5; cursor: not-allowed; }
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <strong style="white-space:nowrap">Carte santé</strong>
    <input id="search" type="search" placeholder="Rechercher pharmacie ou établissement (nom, ville)…" />
    <button id="zoomBtn" class="btn" title="Zoomer sur les résultats visibles">Zoomer sur résultats</button>
    <span class="badge" id="countBadge">0 éléments</span>
    <div class="filter" style="grid-column: 1 / -1;">
      <label for="scoreSlider">Score min</label>
      <input id="scoreSlider" type="range" min="0" max="1" step="0.01" value="0.60" />
      <span id="scoreValue">0.60</span>
    </div>
    <div id="localInputs" style="display:none; gap:8px; align-items:center">
      <label style="font-size:12px">Pharmacies <input id="pharmaFile" type="file" accept=".csv" /></label>
      <label style="font-size:12px">Établissements <input id="ehpadFile" type="file" accept=".csv" /></label>
    </div>
  </div>
  <div id="map"></div>
  <div class="legend" id="legend">
    <h4>Légende</h4>
    <div class="row"><span class="swatch pharma"></span> Pharmacies (<span id="legendPhCount">0</span>)</div>
    <div class="row"><span class="swatch ehpad"></span> Établissements (<span id="legendEhCount">0</span>)</div>
    <div class="row">Score min: <strong id="legendScore">0.60</strong></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script>
(function() {
  const MAX_ZOOM = 19; // zoom très proche mais légèrement réduit
  const MULTI_ZOOM = 17; // zoom rapproché pour plusieurs résultats
  const map = L.map('map', { zoomControl: true, maxZoom: 22 }).setView([46.6, 2.5], 6);
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
    maxZoom: 22
  }).addTo(map);

  const iconPharma = L.divIcon({
    className: 'icon-pharma',
    html: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="12" r="10" fill="#22c55e" opacity="0.18"/>
      <rect x="6.2" y="9" width="11.6" height="8.2" rx="2" fill="#16a34a" stroke="#0f753f" stroke-width="0.6"/>
      <rect x="9" y="7.2" width="6" height="2.2" rx="1.1" fill="#16a34a" stroke="#0f753f" stroke-width="0.6"/>
      <path d="M12 10.6v2.0m0 0v2.0m0-2.0h2.0m-2.0 0h-2.0" stroke="#ffffff" stroke-width="1.6" stroke-linecap="round"/>
    </svg>`,
    iconSize: [28, 28], iconAnchor: [14, 14]
  });

  const iconEhpad = L.divIcon({
    className: 'icon-ehpad',
    html: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="12" r="10" fill="#2563eb" opacity="0.15"/>
      <path d="M4 11l8-6 8 6v7h-5v-4H9v4H4v-7z" fill="#2563eb"/>
    </svg>`,
    iconSize: [28, 28], iconAnchor: [14, 14]
  });

  const layerPharmacies = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
  const layerEhpads = L.markerClusterGroup({ disableClusteringAtZoom: 16 });

  const allMarkers = [];

  function normalize(str) {
    return (str || '').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
  }

  function addMarker(lat, lon, type, props) {
    if (!lat || !lon || isNaN(lat) || isNaN(lon)) return;
    const latNum = Number(lat), lonNum = Number(lon);
    if (!isFinite(latNum) || !isFinite(lonNum)) return;

    const icon = type === 'pharma' ? iconPharma : iconEhpad;
    const marker = L.marker([latNum, lonNum], { icon });
    const title = props.name || '(Sans nom)';
    const addr = props.address || '';
    const score = props.score != null && props.score !== '' ? Number(props.score) : null;
    const scoreText = score != null && isFinite(score) ? ` | score: ${score.toFixed(2)}` : '';
    marker.bindPopup(`<strong>${title}</strong><br>${addr}${scoreText}`);
    marker.featureProps = {
      type,
      search: normalize(`${title} ${addr} ${props.city || ''}`),
      score: score
    };
    (type === 'pharma' ? layerPharmacies : layerEhpads).addLayer(marker);
    allMarkers.push(marker);
  }

  function updateBadge() {
    const ph = layerPharmacies.getLayers().length;
    const eh = layerEhpads.getLayers().length;
    const total = ph + eh;
    document.getElementById('countBadge').textContent = `${total} éléments`;
    document.getElementById('legendPhCount').textContent = ph;
    document.getElementById('legendEhCount').textContent = eh;
  }

  let initialFitDone = false;
  function fitToData() {
    // Do not auto-fit on first load to keep France view as default
    if (!initialFitDone) { initialFitDone = true; return; }
    const group = L.featureGroup([...layerPharmacies.getLayers(), ...layerEhpads.getLayers()]);
    if (group.getLayers().length > 0) {
      map.fitBounds(group.getBounds().pad(0.1));
    }
  }

  function loadCSV(url, onRow) {
    return new Promise((resolve, reject) => {
      Papa.parse(url, {
        download: true,
        header: true,
        delimiter: ';',
        skipEmptyLines: true,
        complete: results => { results.data.forEach(onRow); resolve(); },
        error: err => reject(err)
      });
    });
  }

  const isFileProtocol = location.protocol === 'file:';

  let layersAdded = false;
  function ensureLayersAddedOnce() {
    if (layersAdded) return;
    L.control.layers({ OSM: osm }, {
      Pharmacies: layerPharmacies,
      Établissements: layerEhpads
    }, { collapsed: false }).addTo(map);
    map.addLayer(layerPharmacies);
    map.addLayer(layerEhpads);
    layersAdded = true;

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        const you = L.circleMarker([latitude, longitude], { radius: 6, color: '#ef4444', fillColor: '#ef4444', fillOpacity: 0.8 });
        you.bindPopup('Vous êtes ici');
        you.addTo(map);
      });
    }
  }

  if (!isFileProtocol) {
    Promise.all([
      loadCSV('Pharmacie_geocoded.csv', row => {
        const lat = row.latitude || row.lat || row.y;
        const lon = row.longitude || row.lon || row.x;
        const name = row['Raison sociale'] || row.Nom || row.name;
        const city = row.commune || row['result_city'] || row.Ville || row.city;
        const address = row.adresse || row['result_label'] || row['result_street'] || '';
        const score = row.result_score || row.score || row['Score'] || row['result_score_next'];
        addMarker(lat, lon, 'pharma', { name, address, city, score });
      }),
      loadCSV('ehpads_geocoded.csv', row => {
        const lat = row.latitude || row.lat || row.y;
        const lon = row.longitude || row.lon || row.x;
        const name = row.Nom || row['Raison sociale'] || row.name;
        const city = row.commune || row['result_city'] || row.Ville || row.city;
        const address = row.adresse || row['result_label'] || row['result_street'] || '';
        const score = row.result_score || row.score || row['Score'] || row['result_score_next'];
        addMarker(lat, lon, 'ehpad', { name, address, city, score });
      })
    ]).then(() => { ensureLayersAddedOnce(); updateBadge(); fitToData(); }).catch(err => {
      console.error(err);
      alert('Erreur de chargement des données CSV');
    });
  } else {
    // Fallback: allow loading local files via file inputs
    document.getElementById('localInputs').style.display = 'flex';
    document.getElementById('countBadge').textContent = 'Mode local : choisissez vos CSV';

    function parseLocalFile(file, onRow) {
      if (!file) return;
      Papa.parse(file, {
        header: true,
        delimiter: ';',
        skipEmptyLines: true,
        complete: results => {
          results.data.forEach(onRow);
          ensureLayersAddedOnce();
          updateBadge();
          fitToData();
        },
        error: err => { console.error(err); alert('Erreur de lecture du fichier: ' + file.name); }
      });
    }

    document.getElementById('pharmaFile').addEventListener('change', (e) => {
      layerPharmacies.clearLayers();
      const file = e.target.files && e.target.files[0];
      parseLocalFile(file, row => {
        const lat = row.latitude || row.lat || row.y;
        const lon = row.longitude || row.lon || row.x;
        const name = row['Raison sociale'] || row.Nom || row.name;
        const city = row.commune || row['result_city'] || row.Ville || row.city;
        const address = row.adresse || row['result_label'] || row['result_street'] || '';
        const score = row.result_score || row.score || row['Score'] || row['result_score_next'];
        addMarker(lat, lon, 'pharma', { name, address, city, score });
      });
    });

    document.getElementById('ehpadFile').addEventListener('change', (e) => {
      layerEhpads.clearLayers();
      const file = e.target.files && e.target.files[0];
      parseLocalFile(file, row => {
        const lat = row.latitude || row.lat || row.y;
        const lon = row.longitude || row.lon || row.x;
        const name = row.Nom || row['Raison sociale'] || row.name;
        const city = row.commune || row['result_city'] || row.Ville || row.city;
        const address = row.adresse || row['result_label'] || row['result_street'] || '';
        const score = row.result_score || row.score || row['Score'] || row['result_score_next'];
        addMarker(lat, lon, 'ehpad', { name, address, city, score });
      });
    });
  }

  const searchInput = document.getElementById('search');
  const zoomBtn = document.getElementById('zoomBtn');
  const scoreSlider = document.getElementById('scoreSlider');
  const scoreValue = document.getElementById('scoreValue');
  const legendScore = document.getElementById('legendScore');
  function performZoomToVisible() {
    const countPh = layerPharmacies.getLayers().length;
    const countEh = layerEhpads.getLayers().length;
    const total = countPh + countEh;
    if (total === 0) return;

    if (total === 1) {
      const only = countPh ? layerPharmacies.getLayers()[0] : layerEhpads.getLayers()[0];
      const ll = only.getLatLng();
      map.setView(ll, MAX_ZOOM, { animate: true });
      return;
    }

    const bounds = L.latLngBounds([]);
    if (countPh) bounds.extend(layerPharmacies.getBounds());
    if (countEh) bounds.extend(layerEhpads.getBounds());
    if (bounds.isValid()) {
      map.fitBounds(bounds.pad(0.10), { animate: true });
      if (map.getZoom() > MULTI_ZOOM) {
        map.setZoom(MULTI_ZOOM, { animate: true });
      }
    }
  }
  function updateZoomBtnState() {
    const visibleCount = layerPharmacies.getLayers().length + layerEhpads.getLayers().length;
    zoomBtn.disabled = visibleCount === 0;
  }
  function applyFilters() {
    const q = normalize(searchInput.value);
    const minScore = Number(scoreSlider.value);

    layerPharmacies.clearLayers();
    layerEhpads.clearLayers();

    allMarkers.forEach(m => {
      const scoreOk = m.featureProps.score == null || isNaN(m.featureProps.score) || m.featureProps.score >= minScore;
      if ((!q || m.featureProps.search.includes(q)) && scoreOk) {
        (m.featureProps.type === 'pharma' ? layerPharmacies : layerEhpads).addLayer(m);
      }
    });

    updateBadge();
    updateZoomBtnState();
    performZoomToVisible();
  }

  searchInput.addEventListener('input', applyFilters);
  scoreSlider.addEventListener('input', () => {
    const v = Number(scoreSlider.value).toFixed(2);
    scoreValue.textContent = v;
    legendScore.textContent = v;
    applyFilters();
  });

  zoomBtn.addEventListener('click', performZoomToVisible);
})();
</script>
</body>
</html>

