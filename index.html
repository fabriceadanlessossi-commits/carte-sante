<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Carte Pharmacies & √âtablissements de sant√© (avec clients Or√©us)</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<style>
  html, body, #app { height: 100vh; margin: 0; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif; overflow: hidden; }
  #map { height: calc(100vh - 84px); }
  .topbar { position: sticky; top: 0; z-index: 1000; display: grid;
    grid-template-columns: auto 1fr auto auto auto auto auto auto auto; gap: 10px; align-items: center;
    padding: 12px 16px; background: linear-gradient(135deg,#1e293b 0%,#0f172a 50%,#020617 100%); color: #fff;
    box-shadow: 0 8px 32px rgba(0,0,0,.3); backdrop-filter: blur(8px); }
  .topbar input[type="search"] { width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #334155; background: rgba(15,23,42,0.8); color: #e2e8f0; font-size: 14px; transition: all 0.2s ease; }
  .topbar input[type="search"]:focus { outline: none; border-color: #22c55e; box-shadow: 0 0 0 3px rgba(34,197,94,0.1); }
  .topbar .badge { background: linear-gradient(135deg,#22c55e,#16a34a); padding: 8px 12px; border-radius: 999px; font-size: 12px; font-weight: 600; box-shadow: 0 2px 8px rgba(34,197,94,0.2); }
  .filter { display: flex; align-items: center; gap: 12px; grid-column: 1 / -1; }
  .filter label { font-size: 13px; opacity: .9; display: flex; align-items: center; gap: 6px; }
  .filter input[type="range"] { accent-color: #22c55e; width: 160px; }
  .legend { position: fixed; z-index: 1000; bottom: 20px; left: 20px; background: rgba(255,255,255,0.95); border-radius: 12px; padding: 16px; box-shadow: 0 8px 32px rgba(0,0,0,.2); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.2); }
  .clients-panel { position: fixed; z-index: 1000; top: 100px; right: 20px; width: 320px; max-height: 60vh; background: rgba(255,255,255,0.95); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,.2); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.2); overflow: hidden; }
  .clients-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: linear-gradient(135deg,#8FC4D8,#7AB8CC); color: white; }
  .clients-header h4 { margin: 0; font-size: 14px; }
  .close-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
  .close-btn:hover { background: rgba(255,255,255,0.2); border-radius: 50%; }
  .clients-content { padding: 16px; max-height: calc(60vh - 60px); overflow-y: auto; }
  .client-item { padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
  .client-item:last-child { border-bottom: none; }
  .client-name { font-weight: 600; color: #1f2937; }
  .client-info { font-size: 12px; color: #6b7280; margin-top: 2px; }
  .client-type { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-top: 4px; }
  .client-type.pharma { background: #fef3c7; color: #92400e; }
  .client-type.ehpad { background: #dbeafe; color: #1e40af; }
  .legend h4 { margin: 0 0 6px; font-size: 14px; color: #0f172a; }
  .legend .row { display: flex; align-items: center; gap: 8px; margin: 4px 0; font-size: 13px; color: #0f172a; }
  .legend .swatch { width: 14px; height: 14px; border-radius: 50%; display: inline-block; border: 2px solid #0f172a11; }
  .legend .swatch.pharma { background: #16a34a; }
  .legend .swatch.ehpad { background: #2563eb; }
  .legend .swatch.client { background: #f59e0b; }
  .leaflet-control-layers { font-size: 13px; }
  .btn { background: linear-gradient(135deg,#8FC4D8,#7AB8CC); color:#fff; border:0; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; font-size: 13px; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(143,196,216,0.2); }
  .btn:hover:not([disabled]) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(143,196,216,0.3); }
  .btn[disabled] { opacity: .5; cursor: not-allowed; transform: none !important; }
  .toggle { background: linear-gradient(135deg,#1e293b,#0f172a); border:0; color:#fff; padding:10px 14px; border-radius:8px; cursor:pointer; font-size: 13px; transition: all 0.2s ease; }
  .toggle:hover { background: linear-gradient(135deg,#334155,#1e293b); }
  .hidden { display: none !important; }
  .brand { display:flex; align-items:center; gap:10px; }
  .brand img { height:40px; width:auto; }
  
  /* Loader */
  .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e293b, #0f172a); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .loader-logo { width: 320px; height: auto; animation: buzzer 2s ease-in-out infinite; }
  .loader-text { color: #e2e8f0; font-size: 18px; font-weight: 600; margin-top: 20px; opacity: 0.8; }
  .loader-progress { width: 300px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 15px; overflow: hidden; }
  .loader-bar { height: 100%; background: linear-gradient(90deg, #8FC4D8, #7AB8CC); width: 0%; transition: width 0.3s ease; border-radius: 2px; }
  
  @keyframes buzzer {
    0% { transform: scale(1) rotate(0deg); }
    25% { transform: scale(1.1) rotate(-2deg); }
    50% { transform: scale(1.2) rotate(2deg); }
    75% { transform: scale(1.1) rotate(-1deg); }
    100% { transform: scale(1) rotate(0deg); }
  }
  
  /* === RESPONSIVE DESIGN === */
  
  /* Mobile Portrait (320px - 480px) */
  @media (max-width: 480px) {
    .topbar {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px 12px;
    }
    
    .topbar input[type="search"] {
      font-size: 13px;
      padding: 10px 12px;
      order: 1;
    }
    
    .topbar .badge {
      font-size: 11px;
      padding: 6px 10px;
      order: 2;
      align-self: center;
    }
    
    /* Premi√®re ligne de boutons */
    .mobile-buttons-row1 {
      display: flex;
      gap: 4px;
      order: 3;
      flex-wrap: wrap;
    }
    
    /* Deuxi√®me ligne de boutons */
    .mobile-buttons-row2 {
      display: flex;
      gap: 4px;
      order: 4;
      flex-wrap: wrap;
    }
    
    .brand {
      order: 5;
      align-self: center;
    }
    
    .filter {
      order: 6;
      flex-direction: column;
      align-items: stretch;
      gap: 8px;
    }
    
    .filter label {
      font-size: 12px;
    }
    
    .filter input[type="range"] {
      width: 100%;
    }
    
    .btn, .toggle {
      font-size: 10px;
      padding: 6px 8px;
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .brand img {
      height: 35px;
    }
    
    .legend {
      bottom: 10px;
      left: 10px;
      right: 10px;
      width: auto;
      padding: 12px;
    }
    
    .legend .row {
      font-size: 12px;
    }
    
    .clients-panel {
      top: 10px;
      left: 10px;
      right: 10px;
      width: auto;
      max-height: 70vh;
    }
    
    .clients-header h4 {
      font-size: 13px;
    }
    
    .clients-content {
      padding: 12px;
      max-height: calc(70vh - 50px);
    }
    
    .client-name {
      font-size: 14px;
    }
    
    .client-info {
      font-size: 11px;
    }
    
    #map {
      height: calc(100vh - 160px);
    }
  }
  
  /* Mobile Landscape & Small Tablets (481px - 768px) */
  @media (min-width: 481px) and (max-width: 768px) {
    .topbar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px 12px;
      align-items: center;
    }
    
    .topbar input[type="search"] {
      font-size: 13px;
      padding: 8px 12px;
      flex: 1;
      min-width: 200px;
      order: 1;
    }
    
    .topbar .badge {
      order: 2;
    }
    
    .brand {
      order: 3;
    }
    
    .btn, .toggle {
      font-size: 11px;
      padding: 6px 10px;
      order: 4;
    }
    
    .filter {
      order: 5;
      width: 100%;
      margin-top: 8px;
    }
    
    .brand img {
      height: 35px;
    }
    
    .filter input[type="range"] {
      width: 120px;
    }
    
    .legend {
      bottom: 15px;
      left: 15px;
      padding: 14px;
    }
    
    .clients-panel {
      top: 15px;
      right: 15px;
      width: 280px;
      max-height: 65vh;
    }
    
    .clients-content {
      max-height: calc(65vh - 55px);
    }
    
    #map {
      height: calc(100vh - 120px);
    }
  }
  
  /* Tablets (769px - 1024px) */
  @media (min-width: 769px) and (max-width: 1024px) {
    .topbar {
      gap: 10px;
      padding: 12px 16px;
    }
    
    .btn, .toggle {
      font-size: 12px;
      padding: 9px 13px;
    }
    
    .clients-panel {
      width: 310px;
    }
    
    #map {
      height: calc(100vh - 90px);
    }
  }
  
  /* Large screens adjustments */
  @media (min-width: 1400px) {
    .topbar {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .clients-panel {
      width: 350px;
    }
  }
  
  /* Landscape orientation specific */
  @media (orientation: landscape) and (max-height: 500px) {
    .topbar {
      padding: 6px 12px;
      gap: 6px;
    }
    
    .btn, .toggle {
      font-size: 10px;
      padding: 6px 8px;
    }
    
    .brand img {
      height: 30px;
    }
    
    .legend {
      bottom: 5px;
      padding: 10px;
    }
    
    .clients-panel {
      top: 10px;
      max-height: 80vh;
    }
    
    #map {
      height: calc(100vh - 70px);
    }
  }
  
  /* Touch-friendly improvements */
  @media (hover: none) and (pointer: coarse) {
    .btn, .toggle {
      min-height: 44px;
      min-width: 44px;
    }
    
    .close-btn {
      min-height: 44px;
      min-width: 44px;
    }
    
    .client-item {
      padding: 12px 0;
      min-height: 44px;
    }
    
    .filter input[type="range"] {
      height: 44px;
    }
  }
</style>
</head>
<body>
<!-- Loader -->
<div class="loader-overlay" id="loader">
  <img src="./oreus_logo.png" alt="Or√©us" class="loader-logo" />
  <div class="loader-text">Chargement des donn√©es sant√©...</div>
  <div class="loader-progress">
    <div class="loader-bar" id="loaderBar"></div>
  </div>
</div>

<div id="app">
  <div class="topbar">
    <div class="brand">
      <strong style="white-space:nowrap">Carte sant√© Or√©us</strong>
    </div>
    <input id="search" type="search" placeholder="Rechercher (nom, commune, CP)‚Ä¶ tags: [EHPAD] [PHARMA] [CLIENT]" />
    <button id="zoomBtn" class="btn" title="Zoomer sur les r√©sultats visibles">Zoom sur r√©sultats</button>
    <span class="badge" id="countBadge">0 √©l√©ments</span>
    <button id="toggleLegend" class="toggle" title="Afficher/masquer la l√©gende">‚ÑπÔ∏è L√©gende</button>
    <button id="toggleFilters" class="toggle" title="Afficher/masquer les filtres">‚öôÔ∏è Filtres</button>
    <button id="exportIgnored" class="btn" title="Exporter les lignes ignor√©es" style="display:none;">üì• Export ignor√©s</button>
    <button id="showClientsAround" class="btn" title="Trouver tous les clients Or√©us autour du client recherch√©">Clients autour</button>
    <button id="analyzeEhpadDensity" class="btn" title="Analyser tous les √©tablissements avec le plus de clients Or√©us autour">Analyse √©tablissements</button>
    <button id="prospectingMode" class="btn" title="Mode prospection - Trouver les √©tablissements √† prospecter autour de vous">Prospection</button>
    <!-- Logo Or√©us -->
    <div class="brand">
      <img src="./oreus_logo.png" alt="Or√©us" title="Or√©us" style="height: 60px; width: auto;" />
    </div>
    <div class="filter" id="filtersPanel">
      <label for="scoreSlider">Score min</label>
      <input id="scoreSlider" type="range" min="0" max="1" step="0.01" value="0.60" />
      <span id="scoreValue">0.60</span>
      <label><input type="checkbox" id="chkEhp" checked> EHPADs</label>
      <label><input type="checkbox" id="chkPh" checked> Pharmacies</label>
      <label><input type="checkbox" id="chkEhpCli" checked> EHPADs (Clients Or√©us)</label>
      <label><input type="checkbox" id="chkPhCli" checked> Pharmacies (Clients Or√©us)</label>
    </div>
  </div>

  <div id="map"></div>

  <div class="legend" id="legend">
    <h4>L√©gende</h4>
    <div class="row"><span class="swatch pharma"></span> Pharmacies (<span id="legendPhCount">0</span>)</div>
    <div class="row"><span class="swatch ehpad"></span> √âtablissements (<span id="legendEhCount">0</span>)</div>
    <div class="row"><span class="swatch client"></span> EHPADs Clients Or√©us (<span id="legendEhpadCliCount">0</span>)</div>
    <div class="row"><span class="swatch client"></span> Pharmacies Clientes Or√©us (<span id="legendPharmCliCount">0</span>)</div>
    <div class="row">Score min: <strong id="legendScore">0.60</strong></div>
  </div>
  
  <!-- Panel des clients Or√©us dans la zone -->
  <div class="clients-panel hidden" id="clientsPanel">
    <div class="clients-header">
      <h4>Clients Or√©us dans la zone</h4>
      <button class="close-btn" id="closeClientsPanel">√ó</button>
    </div>
    <div class="clients-content" id="clientsContent">
      <p>D√©placez la carte pour voir les clients Or√©us dans la zone visible</p>
    </div>
  </div>
  
  <!-- Panel de prospection -->
  <div class="clients-panel hidden" id="prospectingPanel">
    <div class="clients-header" style="background: linear-gradient(135deg,#8FC4D8,#7AB8CC);">
      <h4>Mode Prospection</h4>
      <button class="close-btn" id="closeProspectingPanel">√ó</button>
    </div>
    <div class="clients-content" id="prospectingContent">
      <div style="margin-bottom: 16px;">
        <div style="margin-bottom: 12px; font-weight: 600; color: #1f2937;">Choisissez votre position :</div>
        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
          <button id="useCurrentLocation" class="btn" style="flex: 1; font-size: 12px; padding: 8px;">Ma position</button>
          <button id="useAddressInput" class="btn" style="flex: 1; font-size: 12px; padding: 8px;">Saisir adresse</button>
        </div>
        <div id="addressInputDiv" class="hidden" style="margin-bottom: 12px;">
          <input type="text" id="addressInput" placeholder="Entrez une adresse..." style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" />
          <button id="searchAddress" class="btn" style="margin-top: 8px; width: 100%; font-size: 12px; padding: 8px;">Rechercher</button>
        </div>
        <div style="margin-bottom: 12px;">
          <label style="font-size: 13px; color: #374151;">Rayon de prospection :</label>
          <select id="prospectingRadius" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; margin-top: 4px;">
            <option value="5">5 km</option>
            <option value="10" selected>10 km</option>
            <option value="15">15 km</option>
            <option value="20">20 km</option>
            <option value="30">30 km</option>
          </select>
        </div>
      </div>
      <div id="prospectingResults">
        <p style="color: #6b7280; font-style: italic;">S√©lectionnez votre position pour commencer la prospection</p>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script>
(function () {
  // --- Chemins relatifs (mettez les fichiers dans le m√™me dossier que cette page) ---
  const URL_PHARMA   = "./Pharmacie_geocoded.csv";
  const URL_EHPAD    = "./ehpads_geocoded.csv";
  const URL_EHPAD_CL = "./EHPAD_OREUS_geocoded.csv";
  const URL_PHIE_CL  = "./PHIE_OREUS.csv";

  // --- Carte & couche OSM ---
  const MAX_ZOOM = 19, MULTI_ZOOM = 17;
  const map = L.map('map', { zoomControl: true, maxZoom: 22 }).setView([46.6, 2.5], 6);
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors', maxZoom: 22
  }).addTo(map);

  // --- Ic√¥nes ---
  const iconPharma = L.divIcon({ className:'icon-pharma', iconSize:[28,28], iconAnchor:[14,14],
    html:`<svg width="28" height="28" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10" fill="#22c55e" opacity="0.18"/>
      <rect x="6.2" y="9" width="11.6" height="8.2" rx="2" fill="#16a34a" stroke="#0f753f" stroke-width="0.6"/>
      <rect x="9" y="7.2" width="6" height="2.2" rx="1.1" fill="#16a34a" stroke="#0f753f" stroke-width="0.6"/>
      <path d="M12 10.6v2m0 0v2m0-2h2m-2 0h-2" stroke="#fff" stroke-width="1.6" stroke-linecap="round"/>
    </svg>`});
  const iconEhpad = L.divIcon({ className:'icon-ehpad', iconSize:[28,28], iconAnchor:[14,14],
    html:`<svg width="28" height="28" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10" fill="#2563eb" opacity="0.15"/>
      <path d="M4 11l8-6 8 6v7h-5v-4H9v4H4v-7z" fill="#2563eb"/>
    </svg>`});
  // Ic√¥ne pour les EHPADs clients Or√©us (orange avec maison)
  const iconEhpadClient = L.divIcon({ className:'icon-ehpad-client', iconSize:[30,30], iconAnchor:[15,15],
    html:`<svg width="30" height="30" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10" fill="#f59e0b" opacity="0.25"/>
      <path d="M4 11l8-6 8 6v7h-5v-4H9v4H4v-7z" fill="#d97706"/>
      <circle cx="12" cy="6" r="1.5" fill="#fff"/>
      <text x="12" y="17" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">O</text>
    </svg>`});
  
  // Ic√¥ne pour les Pharmacies clientes Or√©us (orange avec croix)
  const iconPharmacieClient = L.divIcon({ className:'icon-pharmacie-client', iconSize:[30,30], iconAnchor:[15,15],
    html:`<svg width="30" height="30" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10" fill="#f59e0b" opacity="0.25"/>
      <rect x="6.2" y="9" width="11.6" height="8.2" rx="2" fill="#d97706" stroke="#b45309" stroke-width="0.6"/>
      <rect x="9" y="7.2" width="6" height="2.2" rx="1.1" fill="#d97706" stroke="#b45309" stroke-width="0.6"/>
      <path d="M12 10.6v2m0 0v2m0-2h2m-2 0h-2" stroke="#fff" stroke-width="1.6" stroke-linecap="round"/>
      <text x="12" y="18" text-anchor="middle" fill="#fff" font-size="6" font-weight="bold">O</text>
    </svg>`});

  // --- Couches cluster ---
  const layerPharmacies   = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
  const layerEhpads       = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
  const layerEhpadClients = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
  const layerPhieClients  = L.markerClusterGroup({ disableClusteringAtZoom: 16 });

  // Contr√¥le des couches synchronis√© avec les checkboxes
  const layerControl = L.control.layers(
    { OSM: osm },
    {
      "Pharmacies": layerPharmacies,
      "√âtablissements": layerEhpads,
      "Clients Or√©us ‚Äì EHPADs": layerEhpadClients,
      "Clients Or√©us ‚Äì Pharmacies": layerPhieClients
    },
    { collapsed: false }
  ).addTo(map);

  [layerPharmacies, layerEhpads, layerEhpadClients, layerPhieClients].forEach(l => map.addLayer(l));
  
  // Synchroniser les couches avec les checkboxes
  function syncLayersWithCheckboxes() {
    if(chkPh.checked && !map.hasLayer(layerPharmacies)) map.addLayer(layerPharmacies);
    if(!chkPh.checked && map.hasLayer(layerPharmacies)) map.removeLayer(layerPharmacies);
    
    if(chkEhp.checked && !map.hasLayer(layerEhpads)) map.addLayer(layerEhpads);
    if(!chkEhp.checked && map.hasLayer(layerEhpads)) map.removeLayer(layerEhpads);
    
    if(chkEhpCl.checked && !map.hasLayer(layerEhpadClients)) map.addLayer(layerEhpadClients);
    if(!chkEhpCl.checked && map.hasLayer(layerEhpadClients)) map.removeLayer(layerEhpadClients);
    
    if(chkPhCl.checked && !map.hasLayer(layerPhieClients)) map.addLayer(layerPhieClients);
    if(!chkPhCl.checked && map.hasLayer(layerPhieClients)) map.removeLayer(layerPhieClients);
  }

  // --- DOM helpers ---
  const $ = id => document.getElementById(id);
  const searchInput = $('search'), zoomBtn = $('zoomBtn');
  const scoreSlider = $('scoreSlider'), scoreValue = $('scoreValue'), legendScore = $('legendScore');
  const chkEhp = $('chkEhp'), chkPh = $('chkPh'), chkEhpCl = $('chkEhpCli'), chkPhCl = $('chkPhCli');
  const legendPh = $('legendPhCount'), legendEh = $('legendEhCount'), legendEhpadCli = $('legendEhpadCliCount'), legendPharmCli = $('legendPharmCliCount'), badge = $('countBadge');
  $('toggleLegend').onclick = () => $('legend').classList.toggle('hidden');
  $('toggleFilters').onclick = () => $('filtersPanel').classList.toggle('hidden');

  // --- Utils parsing ---
  const norm = s => (s||'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
  const num  = v => { if(v==null||v==='') return null; const n=Number(String(v).replace(',','.')); return isFinite(n)?n:null; };

  // √©largir la d√©tection de colonnes lat/lon
  const pickLat = r => {
    const val = r.result_lat ?? r.result_latitude ?? r.latitude ?? r.Latitude ?? r.lat ?? r.y ?? r.lat_wgs84 ?? r.lat_wgs ?? r.lat_dd;
    return val !== undefined && val !== null && val !== '' ? val : null;
  };
  const pickLon = r => {
    const val = r.result_lon ?? r.result_longitude ?? r.longitude ?? r.Longitude ?? r.lon ?? r.lng ?? r.x ?? r.lon_wgs84 ?? r.lng_wgs ?? r.lon_dd;
    return val !== undefined && val !== null && val !== '' ? val : null;
  };
  const pickScore = r => num(r.result_score ?? r.score ?? r.Score ?? r.result_score_next);

  // --- Catalogue complet (source de v√©rit√©) ---
  const catalog = []; // {type, isClient, score, search, marker}
  const allIgnoredRows = []; // pour l'export

  // mapping souple de cl√©s pour les popups
  const keyMap = {
    'designation':['d√©signation','designation','nom','name','raison sociale','raison_sociale','finess'],
    'reference':['r√©f√©rence','reference','ref','code','id','r√©f','numero','siret'],
    'enseigne':['enseigne','enseigne commerciale','groupe','chain','libell√© cat√©gorie'],
    'representant':['repr√©sentant','representant','commercial','rep','attach√©','attache'],
    'famille':['famille','type','categorie','cat√©gorie','family','libell√© statut'],
    'secteur':['secteur','zone','territoire','region','r√©gion','secteur geo','secteur g√©o','d√©partement'],
    'tel':['t√©l','telephone','t√©l√©phone','phone','tel'],
    'code_postal':['code_postal','cp','postcode','code postal'],
    'commune':['commune','ville','city','localite','localit√©'],
    'topclient':['topclient','top client','vip','client_prioritaire']
  };

  function findFirst(row, aliases){
    const keys = Object.keys(row);
    // on cherche en ignorant accents/casse/espace
    const normKey = k => norm(k).replace(/\s|_/g,'');
    const index = Object.fromEntries(keys.map(k=>[normKey(k),k]));
    for(const a of aliases){
      const nk = normKey(a);
      if(index[nk]!=null && row[index[nk]]!=null && String(row[index[nk]]).trim()!==''){
        return String(row[index[nk]]);
      }
    }
    return '';
  }

  function buildPopup(row, isClient, type){
    const fields = [
      ['D√©signation', findFirst(row, keyMap.designation)],
      ['R√©f√©rence',   findFirst(row, keyMap.reference)],
      ['Enseigne',    findFirst(row, keyMap.enseigne)],
      ['Repr√©sentant',findFirst(row, keyMap.representant)],
      ['Famille',     findFirst(row, keyMap.famille)],
      ['Secteur',     findFirst(row, keyMap.secteur)],
      ['T√©l',         findFirst(row, keyMap.tel)],
      ['code_postal', findFirst(row, keyMap.code_postal)],
      ['commune',     findFirst(row, keyMap.commune)],
      ['TOPCLIENT',   findFirst(row, keyMap.topclient) || (isClient ? 'Oui' : '')]
    ];
    const rows = fields
      .filter(([_,v]) => v!=='' && v!=null)
      .map(([k,v])=>{
        // auto-lien si URL
        if(/^https?:\/\//i.test(v)) v = `<a href="${v}" target="_blank" rel="noopener">${v}</a>`;
        return `<tr><th style="text-align:left;padding-right:6px;vertical-align:top;">${k}</th><td>${v}</td></tr>`;
      })
      .join('');
    const name = fields[0][1] || '(Sans nom)';
    const commune = fields[8][1] || '';
    const cp = fields[7][1] || '';
    const header = `<strong>${name}</strong>${(commune||cp)?` ‚Äî <span style="opacity:.8">${[commune,cp].filter(Boolean).join(' ')}</span>`:""}`;
    const badge = isClient ? `<div style="margin-bottom:6px;padding:4px 8px;border-radius:999px;background:#f59e0b22;color:#9a6700;font-weight:700;display:inline-block;">Client Or√©us ‚úÖ</div>` : "";
    return `${header}<div style="margin-top:6px">${badge}<table>${rows}</table></div>`;
  }

  function addRecord(type, row, isClient, stats){
    const lat=num(pickLat(row)), lon=num(pickLon(row));
    
    // Debug pour PHIE_OREUS
    if(isClient && type==='pharma'){
      console.log('üîç PHIE_OREUS Debug:', {
        designation: row['D√©signation'] || row['designation'],
        lat_raw: pickLat(row),
        lon_raw: pickLon(row),
        lat_parsed: lat,
        lon_parsed: lon,
        all_keys: Object.keys(row),
        row_sample: row
      });
    }
    
    if(lat==null || lon==null){ 
      stats.skipped.latlon_missing++; 
      if(isClient && type==='pharma'){
        console.warn('‚ùå PHIE_OREUS ignor√© (pas de coordonn√©es):', row);
      }
      return {added:false, reason:'latlon_missing'}; 
    }
    
    // S√©lection de l'ic√¥ne en fonction du type et du statut client
    let icon;
    if(isClient) {
      icon = type === 'pharma' ? iconPharmacieClient : iconEhpadClient;
    } else {
      icon = type === 'pharma' ? iconPharma : iconEhpad;
    }
    const popup = buildPopup(row, isClient, type);
    const m = L.marker([lat,lon], {icon}).bindPopup(popup, {maxWidth:420});
    catalog.push({ type, isClient, score: pickScore(row), search: norm(Object.values(row).join(' ')), marker: m });
    stats.added++;
    
    if(isClient && type==='pharma'){
      console.log('‚úÖ PHIE_OREUS ajout√©:', row['D√©signation'] || row['designation']);
    }
    
    return {added:true};
  }

  // --- Chargement CSV avec d√©tection automatique du d√©limiteur ---
  function loadCSV(url, onRow){
    const stats = { url, added:0, skipped:{latlon_missing:0, other:0}, ignored_rows: [] };
    return new Promise((resolve,reject)=>{
      // D√©tecter le d√©limiteur en fonction du fichier
      let delimiter = ',';
      if(url.includes('Pharmacie_geocoded.csv') || url.includes('ehpads_geocoded.csv')){
        delimiter = ';';
      }
      
      Papa.parse(url,{
        download:true, 
        header:true, 
        skipEmptyLines:true,
        delimiter: delimiter,
        complete: res=>{
          if(!res || !res.data){ reject(new Error('CSV vide: '+url)); return; }
          res.data.forEach((r, index)=>{
            try{
              const out = onRow(r, stats);
              if(!out || !out.added) {
                stats.skipped.other++;
                if(out && out.reason === 'latlon_missing'){
                  stats.ignored_rows.push({...r, _row_index: index + 2}); // +2 car header + index 0-based
                }
              }
            }catch(e){ 
              stats.skipped.other++; 
              stats.skipped.total++;
              console.warn('Erreur ligne:', e, r);
            }
          });
          console.log(`‚úÖ ${url} : ${res.data.length} lignes charg√©es, ${stats.added} ajout√©es, ${stats.skipped.total} ignor√©es`);
          if(stats.skipped.total > 0) {
            console.log(`   ‚û°Ô∏è D√©tail ignor√©es: ${stats.skipped.latlon_missing} sans lat/lon, ${stats.skipped.score_low} score trop bas`);
          }
          updateLoader(); // Mettre √† jour le loader
          rebuild();
        },
        error: err=>reject(err)
      });
    });
  }

  // --- Reconstruction (appliqu√©e aux filtres/checkbox/recherche) ---
  function parseTags(q){
    const t={ehpad:false,pharma:false,client:false};
    (q.match(/\[(.*?)\]/g)||[]).forEach(s=>{ const x=s.toLowerCase(); if(x.includes('ehpad'))t.ehpad=true; if(x.includes('pharma'))t.pharma=true; if(x.includes('client'))t.client=true; });
    return t;
  }

  function rebuild(){
    const qraw = searchInput.value||"", tags=parseTags(qraw);
    const q = norm(qraw.replace(/\[(.*?)\]/g,'').trim());
    const minScore = Number(scoreSlider.value);

    [layerPharmacies,layerEhpads,layerEhpadClients,layerPhieClients].forEach(l=>l.clearLayers());

    catalog.forEach(rec=>{
      // tags + cases √† cocher
      let typeOk=true;
      if(tags.ehpad || tags.pharma || tags.client){
        typeOk = false;
        if(tags.ehpad  && rec.type==='ehpad')  typeOk=true;
        if(tags.pharma && rec.type==='pharma') typeOk=true;
        if(tags.client && rec.isClient)        typeOk=true;
      } else {
        // Pas de tags sp√©cifiques, on utilise les cases √† cocher
        if(!rec.isClient && rec.type==='ehpad'  && !chkEhp.checked)   typeOk=false;
        if(!rec.isClient && rec.type==='pharma' && !chkPh.checked)    typeOk=false;
        if( rec.isClient && rec.type==='ehpad'  && !chkEhpCl.checked) typeOk=false;
        if( rec.isClient && rec.type==='pharma' && !chkPhCl.checked)  typeOk=false;
      }
      if(!typeOk) return;

      const scoreOk = (rec.score==null || isNaN(rec.score) || rec.score>=minScore);
      const qOk = (!q || rec.search.includes(q));
      if(!scoreOk || !qOk) return;

      if(rec.isClient && rec.type==='ehpad') layerEhpadClients.addLayer(rec.marker);
      else if(rec.isClient && rec.type==='pharma') layerPhieClients.addLayer(rec.marker);
      else if(!rec.isClient && rec.type==='ehpad') layerEhpads.addLayer(rec.marker);
      else layerPharmacies.addLayer(rec.marker);
    });

    // compteurs
    const ph   = layerPharmacies.getLayers().length;
    const eh   = layerEhpads.getLayers().length;
    const phcl = layerPhieClients.getLayers().length;
    const ehcl = layerEhpadClients.getLayers().length;
    const total = ph+eh+phcl+ehcl;
    badge.textContent = `${total} √©l√©ments`;
    legendPh.textContent = ph;
    legendEh.textContent = eh;
    legendEhpadCli.textContent = ehcl;
    legendPharmCli.textContent = phcl;

    zoomBtn.disabled = total===0;
  }

  // --- Zoom helper ---
  let firstFit=false;
  function fitToData(){
    if(!firstFit){ firstFit=true; return; }
    const group = L.featureGroup([
      ...layerPharmacies.getLayers(),
      ...layerEhpads.getLayers(),
      ...layerEhpadClients.getLayers(),
      ...layerPhieClients.getLayers()
    ]);
    if(!group.getLayers().length) return;
    const b = group.getBounds();
    if(b.isValid()){
      map.fitBounds(b.pad(0.10), {animate:true});
      if(map.getZoom()>MULTI_ZOOM) map.setZoom(MULTI_ZOOM,{animate:true});
    }
  }

  // --- Charge 4 CSV ---
  Promise.all([
    loadCSV(URL_PHARMA,   (r,stats) => addRecord('pharma', r, false, stats)),
    loadCSV(URL_EHPAD,    (r,stats) => addRecord('ehpad',  r, false, stats)),
    loadCSV(URL_PHIE_CL,  (r,stats) => addRecord('pharma', r, true,  stats)),  // clients Or√©us PHIE
    loadCSV(URL_EHPAD_CL, (r,stats) => addRecord('ehpad',  r, true,  stats))   // clients Or√©us EHPAD
  ]).then((statsList)=>{
      syncLayersWithCheckboxes();
      rebuild(); fitToData();
      
      // Collecter toutes les lignes ignor√©es
      statsList.forEach(stats => {
        if(stats.ignored_rows && stats.ignored_rows.length > 0){
          stats.ignored_rows.forEach(row => {
            allIgnoredRows.push({...row, _source_file: stats.url});
          });
        }
      });
      
      // alerte si beaucoup d'ignores pour cause lat/lon
      const missing = statsList.reduce((a,s)=>a+s.skipped.latlon_missing,0);
      if(missing>0){
        console.warn(`Attention: ${missing} lignes ignor√©es faute de lat/lon. V√©rifiez les colonnes de coordonn√©es ou la qualit√© du g√©ocodage.`);
        $('exportIgnored').style.display = 'block';
      }
    })
    .catch(err=>{ console.error('Chargement √©chou√©:', err); rebuild(); });

  // --- UI events ---
  function syncScore(){ const v=Number(scoreSlider.value).toFixed(2); scoreValue.textContent=v; legendScore.textContent=v; }
  searchInput.addEventListener('input', ()=>{ rebuild(); });
  scoreSlider.addEventListener('input', ()=>{ syncScore(); rebuild(); });
  [chkEhp,chkPh,chkEhpCl,chkPhCl].forEach(el=> el.addEventListener('change', ()=>{ 
    syncLayersWithCheckboxes(); 
    rebuild(); 
    fitToData(); 
  }));
  zoomBtn.addEventListener('click', fitToData);
  
  // Export des lignes ignor√©es
  $('exportIgnored').addEventListener('click', ()=>{
    if(allIgnoredRows.length === 0){
      alert('Aucune ligne ignor√©e √† exporter.');
      return;
    }
    
    const csv = Papa.unparse(allIgnoredRows);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'ignored_rows.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log(`‚úÖ Export termin√©: ${allIgnoredRows.length} lignes ignor√©es export√©es dans ignored_rows.csv`);
  });
  
  
  // Fonction pour calculer la distance entre deux points (en km)
  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Rayon de la Terre en km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }
  
  // Fonction pour trouver tous les clients Or√©us autour d'un client recherch√© OU d'un EHPAD
  function getClientsAroundSearched(radiusKm = 100) {
    const qraw = searchInput.value||"";
    const q = norm(qraw.replace(/\[(.*?)\]/g,'').trim());
    
    if(!q) {
      alert('Veuillez d\'abord rechercher un √©tablissement dans la barre de recherche');
      return [];
    }
    
    // Trouver l'√©tablissement recherch√© (client OU EHPAD)
    let searchedEstablishment = null;
    for(let rec of catalog) {
      if(rec.search.includes(q)) {
        searchedEstablishment = rec;
        break;
      }
    }
    
    if(!searchedEstablishment) {
      alert('Aucun √©tablissement trouv√© avec cette recherche');
      return [];
    }
    
    const centerPos = searchedEstablishment.marker.getLatLng();
    const clientsAround = [];
    
    // Trouver tous les clients Or√©us dans le rayon (sans exclure le centre s'il est client)
    catalog.forEach(rec => {
      if(!rec.isClient) return;
      if(rec === searchedEstablishment && searchedEstablishment.isClient) return; // Exclure seulement si c'est le m√™me client
      
      const clientPos = rec.marker.getLatLng();
      const distance = calculateDistance(
        centerPos.lat, centerPos.lng,
        clientPos.lat, clientPos.lng
      );
      
      if(distance <= radiusKm) {
        clientsAround.push({
          ...rec,
          distance: Math.round(distance * 10) / 10 // Arrondir √† 1 d√©cimale
        });
      }
    });
    
    // Trier par distance
    clientsAround.sort((a, b) => a.distance - b.distance);
    
    console.log(`üîç Recherche autour de "${searchedEstablishment.search.substring(0,50)}": ${clientsAround.length} clients trouv√©s dans ${radiusKm}km`);
    
    return {
      center: searchedEstablishment,
      clients: clientsAround,
      radius: radiusKm
    };
  }
  
  // Afficher les clients dans le panel
  function displayClientsInPanel(clients, isAroundMode = false, centerClient = null, radius = null) {
    const content = $('clientsContent');
    
    if(clients.length === 0) {
      const message = isAroundMode ? 
        'Aucun autre client Or√©us trouv√© dans le rayon sp√©cifi√©' : 
        'Aucun client Or√©us visible dans cette zone';
      content.innerHTML = `<p style="color: #6b7280; font-style: italic;">${message}</p>`;
      return;
    }
    
    const html = clients.map(client => {
      // Extraire les infos du marker popup
      const popupContent = client.marker.getPopup().getContent();
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = popupContent;
      
      const name = tempDiv.querySelector('strong')?.textContent || 'Nom non disponible';
      const typeClass = client.type === 'pharma' ? 'pharma' : 'ehpad';
      const typeLabel = client.type === 'pharma' ? 'Pharmacie' : 'EHPAD';
      
      // Extraire commune et CP depuis le popup
      const infoSpan = tempDiv.querySelector('span[style*="opacity"]');
      const location = infoSpan ? infoSpan.textContent : '';
      
      const distanceInfo = client.distance ? 
        `<div style="font-size: 11px; color: #059669; font-weight: 600;">üìç ${client.distance} km</div>` : '';
      
      return `
        <div class="client-item" data-lat="${client.marker.getLatLng().lat}" data-lng="${client.marker.getLatLng().lng}" style="cursor: pointer;">
          <div class="client-name">${name}</div>
          <div class="client-info">${location}</div>
          ${distanceInfo}
          <span class="client-type ${typeClass}">${typeLabel} Client Or√©us</span>
        </div>
      `;
    }).join('');
    
    let headerInfo = '';
    if(isAroundMode && centerClient) {
      const centerPopup = centerClient.marker.getPopup().getContent();
      const centerDiv = document.createElement('div');
      centerDiv.innerHTML = centerPopup;
      const centerName = centerDiv.querySelector('strong')?.textContent || 'Client recherch√©';
      
      headerInfo = `
        <div style="margin-bottom: 12px; padding: 8px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #0ea5e9;">
          <div style="font-size: 12px; color: #0369a1; font-weight: 600;">üìç Centre de recherche:</div>
          <div style="font-size: 13px; color: #1e40af; font-weight: 600;">${centerName}</div>
          <div style="font-size: 11px; color: #64748b;">Rayon: ${radius} km</div>
        </div>
      `;
    }
    
    content.innerHTML = `
      ${headerInfo}
      <div style="margin-bottom: 12px; font-size: 13px; color: #374151;">
        <strong>${clients.length}</strong> client${clients.length > 1 ? 's' : ''} Or√©us ${isAroundMode ? 'autour' : 'dans la zone'}
      </div>
      ${html}
    `;
    
    // Ajouter les event listeners pour les clients
    content.querySelectorAll('.client-item[data-lat]').forEach(item => {
      item.addEventListener('click', () => {
        const lat = parseFloat(item.dataset.lat);
        const lng = parseFloat(item.dataset.lng);
        map.setView([lat, lng], 16);
        
        // Trouver et ouvrir le marker correspondant
        let foundMarker = null;
        let foundRec = null;
        catalog.forEach(rec => {
          const markerPos = rec.marker.getLatLng();
          if(Math.abs(markerPos.lat - lat) < 0.001 && Math.abs(markerPos.lng - lng) < 0.001) {
            foundMarker = rec.marker;
            foundRec = rec;
          }
        });
        
        if(foundMarker && foundRec) {
          // Forcer l'affichage du layer si n√©cessaire
          if(foundRec.isClient && foundRec.type === 'ehpad') {
            if(!map.hasLayer(layerEhpadClients)) map.addLayer(layerEhpadClients);
            if(!layerEhpadClients.hasLayer(foundMarker)) layerEhpadClients.addLayer(foundMarker);
          } else if(foundRec.isClient && foundRec.type === 'pharma') {
            if(!map.hasLayer(layerPhieClients)) map.addLayer(layerPhieClients);
            if(!layerPhieClients.hasLayer(foundMarker)) layerPhieClients.addLayer(foundMarker);
          } else if(!foundRec.isClient && foundRec.type === 'ehpad') {
            if(!map.hasLayer(layerEhpads)) map.addLayer(layerEhpads);
            if(!layerEhpads.hasLayer(foundMarker)) layerEhpads.addLayer(foundMarker);
          } else if(!foundRec.isClient && foundRec.type === 'pharma') {
            if(!map.hasLayer(layerPharmacies)) map.addLayer(layerPharmacies);
            if(!layerPharmacies.hasLayer(foundMarker)) layerPharmacies.addLayer(foundMarker);
          }
          
          // Ouvrir la popup apr√®s un petit d√©lai
          setTimeout(() => {
            foundMarker.openPopup();
          }, 200);
        }
      });
    });
  }
  
  
  // Bouton pour afficher les clients autour du client recherch√©
  $('showClientsAround').addEventListener('click', () => {
    const result = getClientsAroundSearched(100); // 100km de rayon
    if(!result || result.clients.length === 0) return;
    
    const panel = $('clientsPanel');
    panel.classList.remove('hidden');
    
    // Centrer la carte sur le client recherch√©
    const centerPos = result.center.marker.getLatLng();
    map.setView([centerPos.lat, centerPos.lng], 10);
    
    // Afficher un cercle de rayon
    if(window.radiusCircle) {
      map.removeLayer(window.radiusCircle);
    }
    window.radiusCircle = L.circle([centerPos.lat, centerPos.lng], {
      radius: result.radius * 1000, // Convertir km en m√®tres
      color: '#f59e0b',
      fillColor: '#fbbf24',
      fillOpacity: 0.1,
      weight: 2,
      dashArray: '5, 5'
    }).addTo(map);
    
    // Forcer l'affichage des clients trouv√©s sur la carte
    result.clients.forEach(client => {
      if(client.type === 'ehpad') {
        if(!layerEhpadClients.hasLayer(client.marker)) {
          layerEhpadClients.addLayer(client.marker);
        }
        if(!map.hasLayer(layerEhpadClients)) {
          map.addLayer(layerEhpadClients);
        }
      } else if(client.type === 'pharma') {
        if(!layerPhieClients.hasLayer(client.marker)) {
          layerPhieClients.addLayer(client.marker);
        }
        if(!map.hasLayer(layerPhieClients)) {
          map.addLayer(layerPhieClients);
        }
      }
    });
    
    // Cocher les cases correspondantes
    chkEhpCl.checked = true;
    chkPhCl.checked = true;
    
    displayClientsInPanel(result.clients, true, result.center, result.radius);
  });
  
  // Fonction d'analyse de TOUS les √©tablissements avec le plus de clients Or√©us autour
  function analyzeEstablishmentDensity(radiusKm = 80) {
    const establishmentAnalysis = [];
    
    // Analyser chaque √©tablissement (EHPAD et Pharmacie non-clients)
    catalog.forEach(establishment => {
      if(establishment.isClient) return; // Exclure les clients Or√©us
      
      const establishmentPos = establishment.marker.getLatLng();
      let clientsAround = 0;
      const nearbyClients = [];
      
      // Compter les clients Or√©us autour
      catalog.forEach(client => {
        if(!client.isClient) return;
        
        const clientPos = client.marker.getLatLng();
        const distance = calculateDistance(
          establishmentPos.lat, establishmentPos.lng,
          clientPos.lat, clientPos.lng
        );
        
        if(distance <= radiusKm) {
          clientsAround++;
          nearbyClients.push({
            ...client,
            distance: Math.round(distance * 10) / 10
          });
        }
      });
      
      if(clientsAround > 0) {
        establishmentAnalysis.push({
          establishment,
          clientsCount: clientsAround,
          nearbyClients: nearbyClients.sort((a, b) => a.distance - b.distance)
        });
      }
    });
    
    // Trier par nombre de clients autour (d√©croissant)
    establishmentAnalysis.sort((a, b) => b.clientsCount - a.clientsCount);
    
    return establishmentAnalysis.slice(0, 10); // Top 10
  }
  
  // Bouton d'analyse des √©tablissements
  $('analyzeEhpadDensity').addEventListener('click', () => {
    const analysis = analyzeEstablishmentDensity(80);
    
    if(analysis.length === 0) {
      alert('Aucun √©tablissement trouv√© avec des clients Or√©us √† proximit√©');
      return;
    }
    
    const panel = $('clientsPanel');
    panel.classList.remove('hidden');
    
    // Afficher le meilleur √©tablissement
    const bestEstablishment = analysis[0];
    const establishmentPos = bestEstablishment.establishment.marker.getLatLng();
    map.setView([establishmentPos.lat, establishmentPos.lng], 11);
    
    // Cr√©er le contenu du panel
    const content = $('clientsContent');
    const topEstablishments = analysis.slice(0, 5).map((item, index) => {
      const establishmentPopup = item.establishment.marker.getPopup().getContent();
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = establishmentPopup;
      const establishmentName = tempDiv.querySelector('strong')?.textContent || '√âtablissement';
      const infoSpan = tempDiv.querySelector('span[style*="opacity"]');
      const location = infoSpan ? infoSpan.textContent : '';
      const typeIcon = item.establishment.type === 'pharma' ? 'üíä' : 'üè•';
      const typeLabel = item.establishment.type === 'pharma' ? 'Pharmacie' : 'EHPAD';
      
      return `
        <div class="client-item" style="cursor: pointer; ${index === 0 ? 'background: #f0f9ff; border-left: 3px solid #0ea5e9;' : ''}" 
             data-lat="${item.establishment.marker.getLatLng().lat}" data-lng="${item.establishment.marker.getLatLng().lng}" data-name="${establishmentName.replace(/'/g, "\\'")}">
          <div class="client-name">${typeIcon} ${establishmentName} ${index === 0 ? 'üèÜ' : ''}</div>
          <div class="client-info">${typeLabel} ‚Ä¢ ${location}</div>
          <div style="font-size: 12px; color: #059669; font-weight: 600; margin-top: 4px;">
            üìç ${item.clientsCount} clients Or√©us dans 80km
          </div>
        </div>
      `;
    }).join('');
    
    content.innerHTML = `
      <div style="margin-bottom: 16px; padding: 12px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e;">
        <div style="font-size: 14px; color: #15803d; font-weight: 700; margin-bottom: 4px;">üèÜ TOP 5 √âtablissements</div>
        <div style="font-size: 12px; color: #166534;">√âtablissements avec le plus de clients Or√©us dans un rayon de 80km</div>
      </div>
      ${topEstablishments}
      <div style="margin-top: 12px; padding: 8px; background: #fef3c7; border-radius: 6px; font-size: 11px; color: #92400e;">
        üí° Cliquez sur un √©tablissement pour le voir sur la carte
      </div>
    `;
    
    // Ajouter les event listeners pour l'analyse des √©tablissements
    content.querySelectorAll('.client-item[data-lat]').forEach(item => {
      item.addEventListener('click', () => {
        const lat = parseFloat(item.dataset.lat);
        const lng = parseFloat(item.dataset.lng);
        const name = item.dataset.name;
        
        // Mettre √† jour la recherche
        if(name) {
          searchInput.value = name;
        }
        
        // Centrer la carte avec un zoom plus fort
        map.setView([lat, lng], 16);
        
        // Trouver et ouvrir le marker correspondant
        let foundMarker = null;
        let foundRec = null;
        catalog.forEach(rec => {
          const markerPos = rec.marker.getLatLng();
          if(Math.abs(markerPos.lat - lat) < 0.001 && Math.abs(markerPos.lng - lng) < 0.001) {
            foundMarker = rec.marker;
            foundRec = rec;
          }
        });
        
        if(foundMarker && foundRec) {
          // Forcer l'affichage du layer si n√©cessaire
          if(foundRec.isClient && foundRec.type === 'ehpad') {
            if(!map.hasLayer(layerEhpadClients)) map.addLayer(layerEhpadClients);
            if(!layerEhpadClients.hasLayer(foundMarker)) layerEhpadClients.addLayer(foundMarker);
          } else if(foundRec.isClient && foundRec.type === 'pharma') {
            if(!map.hasLayer(layerPhieClients)) map.addLayer(layerPhieClients);
            if(!layerPhieClients.hasLayer(foundMarker)) layerPhieClients.addLayer(foundMarker);
          } else if(!foundRec.isClient && foundRec.type === 'ehpad') {
            if(!map.hasLayer(layerEhpads)) map.addLayer(layerEhpads);
            if(!layerEhpads.hasLayer(foundMarker)) layerEhpads.addLayer(foundMarker);
          } else if(!foundRec.isClient && foundRec.type === 'pharma') {
            if(!map.hasLayer(layerPharmacies)) map.addLayer(layerPharmacies);
            if(!layerPharmacies.hasLayer(foundMarker)) layerPharmacies.addLayer(foundMarker);
          }
          
          // D√©clencher un rebuild pour s'assurer que les filtres sont appliqu√©s
          rebuild();
          
          // Ouvrir la popup apr√®s un d√©lai
          setTimeout(() => {
            foundMarker.openPopup();
          }, 300);
        }
      });
    });
  });
  
  // Fermer le panel
  $('closeClientsPanel').addEventListener('click', () => {
    $('clientsPanel').classList.add('hidden');
  });
  
  // === MODE PROSPECTION ===
  
  // Variables globales pour la prospection
  let prospectingCenter = null;
  let prospectingCircle = null;
  
  // Fonction pour g√©ocoder une adresse
  async function geocodeAddress(address) {
    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=fr&limit=1`);
      const data = await response.json();
      if(data && data.length > 0) {
        return {
          lat: parseFloat(data[0].lat),
          lng: parseFloat(data[0].lon),
          display_name: data[0].display_name
        };
      }
      return null;
    } catch(error) {
      console.error('Erreur g√©ocodage:', error);
      return null;
    }
  }
  
  // Fonction pour trouver tous les √©tablissements autour d'une position
  function getEstablishmentsAround(centerLat, centerLng, radiusKm) {
    const establishments = [];
    
    catalog.forEach(rec => {
      const distance = calculateDistance(centerLat, centerLng, rec.marker.getLatLng().lat, rec.marker.getLatLng().lng);
      
      if(distance <= radiusKm) {
        establishments.push({
          ...rec,
          distance: Math.round(distance * 10) / 10
        });
      }
    });
    
    // Trier par distance puis par statut (non-clients en premier pour prospection)
    establishments.sort((a, b) => {
      if(a.isClient !== b.isClient) {
        return a.isClient ? 1 : -1; // Non-clients en premier
      }
      return a.distance - b.distance;
    });
    
    return establishments;
  }
  
  // Fonction pour afficher les r√©sultats de prospection
  function displayProspectingResults(establishments, centerInfo) {
    const content = $('prospectingResults');
    
    if(establishments.length === 0) {
      content.innerHTML = '<p style="color: #6b7280; font-style: italic;">Aucun √©tablissement trouv√© dans cette zone</p>';
      return;
    }
    
    const nonClients = establishments.filter(e => !e.isClient);
    const clients = establishments.filter(e => e.isClient);
    
    const html = `
      <div style="margin-bottom: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #8FC4D8;">
        <div style="font-size: 12px; color: #0369a1; font-weight: 600;">üìç Centre de prospection:</div>
        <div style="font-size: 13px; color: #1e40af; font-weight: 600;">${centerInfo}</div>
        <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
          üéØ ${nonClients.length} prospects ‚Ä¢ ‚úÖ ${clients.length} clients Or√©us
        </div>
      </div>
      
      ${nonClients.length > 0 ? `
        <div style="margin-bottom: 16px;">
          <div style="font-size: 14px; font-weight: 700; color: #dc2626; margin-bottom: 8px;">üéØ PROSPECTS (${nonClients.length})</div>
          ${nonClients.slice(0, 10).map(est => {
            const popupContent = est.marker.getPopup().getContent();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = popupContent;
            const name = tempDiv.querySelector('strong')?.textContent || '√âtablissement';
            const infoSpan = tempDiv.querySelector('span[style*="opacity"]');
            const location = infoSpan ? infoSpan.textContent : '';
            const typeIcon = est.type === 'pharma' ? 'üíä' : 'üè•';
            const typeLabel = est.type === 'pharma' ? 'Pharmacie' : 'EHPAD';
            
            return `
              <div class="client-item" style="cursor: pointer; border-left: 3px solid #dc2626;" 
                   data-lat="${est.marker.getLatLng().lat}" data-lng="${est.marker.getLatLng().lng}">
                <div class="client-name">${typeIcon} ${name}</div>
                <div class="client-info">${typeLabel} ‚Ä¢ ${location}</div>
                <div style="font-size: 11px; color: #dc2626; font-weight: 600;">üìç ${est.distance} km ‚Ä¢ üéØ PROSPECT</div>
              </div>
            `;
          }).join('')}
          ${nonClients.length > 10 ? `<div style="font-size: 12px; color: #6b7280; text-align: center; margin-top: 8px;">... et ${nonClients.length - 10} autres prospects</div>` : ''}
        </div>
      ` : ''}
      
      ${clients.length > 0 ? `
        <div>
          <div style="font-size: 14px; font-weight: 700; color: #059669; margin-bottom: 8px;">‚úÖ CLIENTS OR√âUS (${clients.length})</div>
          ${clients.slice(0, 5).map(est => {
            const popupContent = est.marker.getPopup().getContent();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = popupContent;
            const name = tempDiv.querySelector('strong')?.textContent || '√âtablissement';
            const infoSpan = tempDiv.querySelector('span[style*="opacity"]');
            const location = infoSpan ? infoSpan.textContent : '';
            const typeIcon = est.type === 'pharma' ? 'üíä' : 'üè•';
            const typeLabel = est.type === 'pharma' ? 'Pharmacie' : 'EHPAD';
            
            return `
              <div class="client-item" style="cursor: pointer; border-left: 3px solid #059669;" 
                   data-lat="${est.marker.getLatLng().lat}" data-lng="${est.marker.getLatLng().lng}">
                <div class="client-name">${typeIcon} ${name}</div>
                <div class="client-info">${typeLabel} ‚Ä¢ ${location}</div>
                <div style="font-size: 11px; color: #059669; font-weight: 600;">üìç ${est.distance} km ‚Ä¢ ‚úÖ CLIENT</div>
              </div>
            `;
          }).join('')}
          ${clients.length > 5 ? `<div style="font-size: 12px; color: #6b7280; text-align: center; margin-top: 8px;">... et ${clients.length - 5} autres clients</div>` : ''}
        </div>
      ` : ''}
    `;
    
    content.innerHTML = html;
    
    // Ajouter les event listeners apr√®s avoir ins√©r√© le HTML
    content.querySelectorAll('.client-item[data-lat]').forEach(item => {
      item.addEventListener('click', () => {
        const lat = parseFloat(item.dataset.lat);
        const lng = parseFloat(item.dataset.lng);
        map.setView([lat, lng], 16);
        
        // Trouver et ouvrir le marker correspondant
        let foundMarker = null;
        let foundRec = null;
        catalog.forEach(rec => {
          const markerPos = rec.marker.getLatLng();
          if(Math.abs(markerPos.lat - lat) < 0.001 && Math.abs(markerPos.lng - lng) < 0.001) {
            foundMarker = rec.marker;
            foundRec = rec;
          }
        });
        
        if(foundMarker && foundRec) {
          // Forcer l'affichage du layer si n√©cessaire
          if(foundRec.isClient && foundRec.type === 'ehpad') {
            if(!map.hasLayer(layerEhpadClients)) map.addLayer(layerEhpadClients);
            if(!layerEhpadClients.hasLayer(foundMarker)) layerEhpadClients.addLayer(foundMarker);
          } else if(foundRec.isClient && foundRec.type === 'pharma') {
            if(!map.hasLayer(layerPhieClients)) map.addLayer(layerPhieClients);
            if(!layerPhieClients.hasLayer(foundMarker)) layerPhieClients.addLayer(foundMarker);
          } else if(!foundRec.isClient && foundRec.type === 'ehpad') {
            if(!map.hasLayer(layerEhpads)) map.addLayer(layerEhpads);
            if(!layerEhpads.hasLayer(foundMarker)) layerEhpads.addLayer(foundMarker);
          } else if(!foundRec.isClient && foundRec.type === 'pharma') {
            if(!map.hasLayer(layerPharmacies)) map.addLayer(layerPharmacies);
            if(!layerPharmacies.hasLayer(foundMarker)) layerPharmacies.addLayer(foundMarker);
          }
          
          // Ouvrir la popup apr√®s un petit d√©lai
          setTimeout(() => {
            foundMarker.openPopup();
          }, 200);
        }
      });
    });
  }
  
  // Bouton mode prospection
  $('prospectingMode').addEventListener('click', () => {
    const panel = $('prospectingPanel');
    panel.classList.remove('hidden');
  });
  
  // Fermer le panel prospection
  $('closeProspectingPanel').addEventListener('click', () => {
    $('prospectingPanel').classList.add('hidden');
    if(prospectingCircle) {
      map.removeLayer(prospectingCircle);
      prospectingCircle = null;
    }
  });
  
  // Utiliser position actuelle
  $('useCurrentLocation').addEventListener('click', () => {
    if(!navigator.geolocation) {
      alert('La g√©olocalisation n\'est pas support√©e par votre navigateur');
      return;
    }
    
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const radius = parseInt($('prospectingRadius').value);
        
        prospectingCenter = {lat, lng};
        
        // Centrer la carte
        map.setView([lat, lng], 12);
        
        // Afficher cercle de prospection
        if(prospectingCircle) map.removeLayer(prospectingCircle);
        prospectingCircle = L.circle([lat, lng], {
          radius: radius * 1000,
          color: '#8FC4D8',
          fillColor: '#8FC4D8',
          fillOpacity: 0.1,
          weight: 2,
          dashArray: '5, 5'
        }).addTo(map);
        
        // Trouver √©tablissements
        const establishments = getEstablishmentsAround(lat, lng, radius);
        displayProspectingResults(establishments, 'Votre position actuelle');
      },
      (error) => {
        alert('Erreur de g√©olocalisation: ' + error.message);
      }
    );
  });
  
  // Utiliser adresse saisie
  $('useAddressInput').addEventListener('click', () => {
    $('addressInputDiv').classList.remove('hidden');
  });
  
  // Rechercher adresse
  $('searchAddress').addEventListener('click', async () => {
    const address = $('addressInput').value.trim();
    if(!address) {
      alert('Veuillez saisir une adresse');
      return;
    }
    
    const result = await geocodeAddress(address);
    if(!result) {
      alert('Adresse non trouv√©e');
      return;
    }
    
    const radius = parseInt($('prospectingRadius').value);
    prospectingCenter = {lat: result.lat, lng: result.lng};
    
    // Centrer la carte
    map.setView([result.lat, result.lng], 12);
    
    // Afficher cercle de prospection
    if(prospectingCircle) map.removeLayer(prospectingCircle);
    prospectingCircle = L.circle([result.lat, result.lng], {
      radius: radius * 1000,
      color: '#8FC4D8',
      fillColor: '#8FC4D8',
      fillOpacity: 0.1,
      weight: 2,
      dashArray: '5, 5'
    }).addTo(map);
    
    // Trouver √©tablissements
    const establishments = getEstablishmentsAround(result.lat, result.lng, radius);
    displayProspectingResults(establishments, result.display_name.split(',').slice(0, 2).join(','));
  });
  
  // Changement de rayon
  $('prospectingRadius').addEventListener('change', () => {
    if(prospectingCenter) {
      const radius = parseInt($('prospectingRadius').value);
      
      // Mettre √† jour le cercle
      if(prospectingCircle) {
        map.removeLayer(prospectingCircle);
        prospectingCircle = L.circle([prospectingCenter.lat, prospectingCenter.lng], {
          radius: radius * 1000,
          color: '#8FC4D8',
          fillColor: '#8FC4D8',
          fillOpacity: 0.1,
          weight: 2,
          dashArray: '5, 5'
        }).addTo(map);
      }
      
      // Recalculer les √©tablissements
      const establishments = getEstablishmentsAround(prospectingCenter.lat, prospectingCenter.lng, radius);
      const centerInfo = $('addressInput').value || 'Votre position actuelle';
      displayProspectingResults(establishments, centerInfo);
    }
  });
  
  
  syncScore();
  
  // --- Loader de chargement ---
  let filesLoaded = 0;
  const totalFiles = 4;
  const loaderBar = document.getElementById('loaderBar');
  const loader = document.getElementById('loader');
  
  function updateLoader() {
    filesLoaded++;
    const progress = (filesLoaded / totalFiles) * 100;
    loaderBar.style.width = progress + '%';
    
    if(filesLoaded >= totalFiles) {
      setTimeout(() => {
        loader.style.opacity = '0';
        loader.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
          loader.style.display = 'none';
        }, 500);
      }, 500);
    }
  }

  // --- Localisation (optionnel) ---
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      L.circleMarker([pos.coords.latitude, pos.coords.longitude], { radius: 6, color: '#ef4444', fillColor: '#ef4444', fillOpacity: 0.8 })
        .bindPopup('Vous √™tes ici').addTo(map);
    });
  }
})();

// --- DEBUG : inspection des CSV charg√©s ---
function inspectCSV(url){
  Papa.parse(url, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: res => {
      updateLoader(); // Mettre √† jour le loader
      if(!res.data || !res.data.length){
        console.warn("‚ùå CSV vide :", url);
        return;
      }
      const cols = Object.keys(res.data[0]);
      console.group("üîé Inspection CSV :", url);
      console.log("Colonnes d√©tect√©es :", cols);
      console.log("Premi√®re ligne :", res.data[0]);
      console.log("Nombre total de lignes :", res.data.length);
      console.groupEnd();
    },
    error: err => console.error("Erreur lecture CSV", url, err)
  });
}

// Debug sp√©cifique pour PHIE_OREUS
function debugPHIE(){
  Papa.parse('./PHIE_OREUS.csv', {
    download: true,
    header: true,
    skipEmptyLines: true,
    delimiter: ',', // Force virgule
    complete: res => {
      if(!res.data || !res.data.length){
        console.warn("‚ùå PHIE_OREUS vide");
        return;
      }
      const firstRow = res.data[0];
      console.group("üîç PHIE_OREUS DETAILED DEBUG");
      console.log("Colonnes:", Object.keys(firstRow));
      console.log("Premi√®re ligne compl√®te:", firstRow);
      console.log("latitude value:", firstRow.latitude, typeof firstRow.latitude);
      console.log("longitude value:", firstRow.longitude, typeof firstRow.longitude);
      console.log("Toutes les cl√©s contenant 'lat':", Object.keys(firstRow).filter(k => k.toLowerCase().includes('lat')));
      console.log("Toutes les cl√©s contenant 'lon':", Object.keys(firstRow).filter(k => k.toLowerCase().includes('lon')));
      
      // Test avec une ligne qui a des coordonn√©es
      const rowWithCoords = res.data.find(row => row.latitude && row.longitude);
      if(rowWithCoords) {
        console.log("Ligne avec coordonn√©es trouv√©e:", rowWithCoords.D√©signation);
        console.log("lat:", rowWithCoords.latitude, "lon:", rowWithCoords.longitude);
      } else {
        console.warn("Aucune ligne avec coordonn√©es trouv√©e!");
      }
      
      console.groupEnd();
    },
    error: err => console.error("Erreur PHIE_OREUS:", err)
  });
}
debugPHIE();

// Lancer l'inspection pour nos 4 fichiers (temporairement activ√© pour debug)
[URL_PHARMA, URL_EHPAD, URL_PHIE_CL, URL_EHPAD_CL].forEach(inspectCSV);


</script>
</body>
</html>
